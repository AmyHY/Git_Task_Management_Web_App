<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>è¡¨æ ¼é¡µ</title>
    <!-- CSS -->
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css">
    <!-- Include Chart.js library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container my-5">
        <h1 class="text-center mb-4">Giteeå·¥ä½œé¡¹æ¦‚è§ˆ</h1>
        <p class="text-center mb-4">é¡¹ç›®åç§°ï¼š<%- issues_data[0].program.name %></p>
        <p class="text-center mb-4">é¡¹ç›®è´Ÿè´£äººï¼š<%- issues_data[0].program.author.name %></p>


        <!-- filter form -->
        <div class="container mt-4">
            <form id="filter_specific_form" method="POST">
                <div class="row justify-content-center">   
                    <div class="col-md-1">
                        <div class="form-group">
                            <label for="repo">ç­›é€‰ä»“åº“</label>
                            <select id="repo" name="repo" class="form-select">
                                <option value="all">All</option>
                                <% const uniquePaths = new Set(); %>
                                <% for (const issue of issues_data) { %>
                                    <% if (issue.repository && issue.repository.path && !uniquePaths.has(issue.repository.path)) { %>
                                        <% uniquePaths.add(issue.repository.path); %>
                                        <option value="<%= issue.repository.path %>"><%= issue.repository.path %></option>
                                    <% } %>
                                <% } %>
                            </select>                            
                        </div>
                    </div> 

                    <div class="col-md-1">
                        <div class="form-group">
                            <label for="milestones">ç­›é€‰é‡Œç¨‹ç¢‘</label>
                            <select id="milestones" name="milestones" class="form-select">
                                <option value="all">All</option>
                                <% const uniqueMilestones = new Set(); %>
                                <% for (const issue of issues_data) { %>
                                    <% if (issue.milestone && issue.milestone.title && !uniqueMilestones.has(issue.milestone.title)) { %>
                                        <% uniqueMilestones.add(issue.milestone.title); %>
                                        <option value="<%= issue.milestone.title %>"><%= issue.milestone.title %></option>
                                    <% } %>
                                <% } %>
                            </select>                            
                        </div>
                    </div>
            
                    <div class="dropdown col-md-1  d-flex justify-content-center">
                        <button class="btn btn-light dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            ç­›é€‰äººå‘˜
                        </button>
                        <div class="dropdown-menu" aria-labelledby="userDropdown">
                            <select id="user" name="user" class="form-select" size="5" multiple>
                                <option value="all">All</option>
                                <% const uniqueUserNames = Array.from(new Set(issues_data.map(issue => issue.assignee.remark !== null ? issue.assignee.remark : issue.assignee.name))); %>
                                <% for (let i = 0; i < uniqueUserNames.length; i++) { %>
                                    <option value="<%= uniqueUserNames[i] %>"><%- uniqueUserNames[i] %></option>
                                <% } %>
                            </select>
                        </div>
                    </div>
                     
            
                    <div class="col-md-2">
                        <div class="form-group">
                            <label for="start-date">Start Date</label>
                            <input type="date" id="start-date" name="start_date" class="form-control">
                        </div>
                    </div> 

                    <div class="col-md-2">
                        <div class="form-group">
                            <label for="end-date">End Date</label>
                            <input type="date" id="end-date" name="end_date" class="form-control">
                        </div>
                    </div>

                    <div class="dropdown col-md-1  d-flex justify-content-center">
                        <button class="btn btn-light dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            å·¥ä½œé¡¹ç±»å‹
                        </button>
                        <div class="dropdown-menu" aria-labelledby="userDropdown">
                            <select id="issue_type" name="issue_type" class="form-select" size="5" multiple>
                                <option value="all">All</option>
                                <option value="ä»»åŠ¡">ä»»åŠ¡</option>
                                <option value="ç¼ºé™·">ç¼ºé™·</option>
                                <option value="éœ€æ±‚">éœ€æ±‚</option>
                            </select>
                        </div>
                    </div>

                    <div class="col-md-1 d-flex justify-content-center">
                        <button type="submit" class="btn btn-primary mt-4">æäº¤</button>
                    </div>
                </div>
            </form>
            
        </div>


        <!-- first table -->
        <div class="container-fluid mx-auto display-table mt-4">
            <div class="table-responsive mt-5">
                <h2 class="text-center mb-4">å·¥ä½œè¿›åº¦</h2>
                <p>æœªå®ŒæˆçŠ¶æ€ = å¾…åŠçš„/å·²ç¡®è®¤/è¿›è¡Œä¸­</p>
                <table class="table table-bordered table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th scope="col">åºå·</th>
                            <th scope="col">å·¥ç¨‹å¸ˆ</th>
                            <th scope="col">é€¾æœŸ+æœªå®Œæˆçš„å·¥ä½œé¡¹ æ•°é‡</th>
                            <th scope="col" id="th_progress">å æ¯” å½“å‰é€¾æœŸ+æœªå®Œæˆæ€»æ•°é‡</th>
                            <th scope="col">å¤‡æ³¨</th>
                        </tr>
                    </thead>
                    <tbody id="tbody_progress">
                        <!-- too be populated later in the script -->
                    </tbody> 
                </table>
            </div>
        </div>

        <!-- é¥¼å›¾ 1 -->
        <div class="chartContainer">
            <canvas id="pieChart1" class="pieChart"></canvas>
        </div>


         <!-- second table -->
         <div class="container-fluid mx-auto display-table mt-4">
            <div class="table-responsive mt-5">
                <h2 class="text-center mb-4">å·¥ä½œæ€åº¦</h2>
                <p>æœªå®ŒæˆçŠ¶æ€ = å¾…åŠçš„/å·²ç¡®è®¤/è¿›è¡Œä¸­</p>
                <table class="table table-bordered table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th scope="col">åºå·</th>
                            <th scope="col">å·¥ç¨‹å¸ˆ</th> 
                            <th scope="col">æ•°é‡ğŸ‘‰</th>
                            <th scope="col">é€¾æœŸ+æœªå®Œæˆ+ä¸”æœªè¯„è®ºçš„å·¥ä½œé¡¹ æ ‡é¢˜&é“¾æ¥</th>
                            <th scope="col">å¤‡æ³¨</th>
                        </tr>
                    </thead>
                    <tbody id="tbody_attitude">
                        <!-- too be populated later in the script -->
                    </tbody> 
                </table>
            </div>
        </div>


        <!-- third table -->
        <div class="container-fluid mx-auto display-table mt-4">
            <div class="table-responsive mt-5">
                <h2 class="text-center mb-4">å·¥ä½œå¼ºåº¦</h2>
                <table class="table table-bordered table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th scope="col">åºå·</th>
                            <th scope="col">å·¥ç¨‹å¸ˆ</th> 
                            <th scope="col">å·¥ä½œé¡¹æ•°é‡</th>
                            <th scope="col" id="th_intensity">å æ¯” æ‰€æœ‰äººå·¥ä½œé¡¹æ€»æ•°é‡</th> 
                            <th scope="col">å¤‡æ³¨</th>
                        </tr>
                    </thead>
                    <tbody id="tbody_intensity">
                        <!-- too be populated later in the script -->
                    </tbody> 
                </table>
            </div>
        </div>

        <!-- é¥¼å›¾ 3 -->
        <div class="chartContainer">
            <canvas id="pieChart3" class="pieChart"></canvas>
        </div>

        <!-- fourth table -->
        <div class="container-fluid mx-auto display-table mt-4">
            <div class="table-responsive mt-5">
                <h2 class="text-center mb-4">ä¸ªäººè¿›åº¦</h2>
                <p>æœªå®ŒæˆçŠ¶æ€ = å¾…åŠçš„/å·²ç¡®è®¤/è¿›è¡Œä¸­</p>
                <table class="table table-bordered table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th scope="col">åºå·</th>
                            <th scope="col">å·¥ç¨‹å¸ˆ</th> 
                            <th scope="col">æœªå®Œæˆå·¥ä½œé¡¹æ•°é‡</th>
                            <th scope="col">æœªå®Œæˆå·¥ä½œé¡¹ å æ¯” æ‰€æœ‰ä¸ªäººä»»åŠ¡</th>
                            <th scope="col">æš‚ä¸å¤„ç†å·¥ä½œé¡¹æ•°é‡</th>
                            <th scope="col">å¤‡æ³¨</th>
                        </tr>
                    </thead>
                    <tbody id="tbody_individual">
                        <!-- too be populated later in the script -->
                    </tbody> 
                </table>
            </div>
        </div>

    </div>
    
    
    <script src="/app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function create_pie_chart(pieChartId, userNames, percentages) {
            let pieChartCanvas = document.getElementById(pieChartId);
            let pieChartInstance = new Chart(pieChartCanvas, {
                type: 'pie',
                data: {
                    labels: userNames,
                    datasets: [{
                        data: percentages,
                        backgroundColor: [
                        'rgba(255, 99, 132, 0.5)', // Red
                        'rgba(54, 162, 235, 0.5)', // Blue
                        'rgba(255, 206, 86, 0.5)', // Yellow
                        'rgba(75, 192, 192, 0.5)', // Teal
                            // ...repeat for other users
                        ],
                        borderColor: [
                        'rgba(255, 99, 132, 1)', // Red
                        'rgba(54, 162, 235, 1)', // Blue
                        'rgba(255, 206, 86, 1)', // Yellow
                        'rgba(75, 192, 192, 1)', // Teal
                            // ...repeat for other users
                        ],
                        borderWidth: 1,
                    }],
                },
                options: {},
            });
            return pieChartInstance;
        }

        // Initialize pie charts
        let pieChartInstance1 = create_pie_chart('pieChart1', [], []);
        let pieChartInstance3 = create_pie_chart('pieChart3', [], []);
        
        
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.querySelector('#filter_specific_form');
            console.log("ç­›é€‰<form>å·²åˆå§‹åŒ–ï¼Œè¯·ç‚¹å‡»ç­›é€‰æŒ‰é’®æ˜¾ç¤ºè¡¨æ ¼ã€‚"); // Debugging


            form.addEventListener('submit', async (event) => {
                event.preventDefault();


                // to fix the bug that user and issue_type selected from the form is undefined
                const selectedUsers = Array.from(document.querySelectorAll('#user option:checked')).map(option => option.value);
                console.log("selectedUsers = ", selectedUsers);
                const selectedTypes = Array.from(document.querySelectorAll('#issue_type option:checked')).map(option => option.value);
                console.log("selectedTypes = ", selectedTypes);


                const formData = new FormData(form);
                const formDataObject = {};
                formData.forEach((value, key) => {
                    formDataObject[key] = value;
                });
              
                formDataObject.user = selectedUsers; // Manually fix the bug of 'user' and 'issue_type' not being an array.
                formDataObject.issue_type = selectedTypes;
                console.log("formDataObject = ", formDataObject);

                const response = await fetch('/filter_specific', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formDataObject),
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const filteredData = await response.json(); // filtereData æ˜¯è¡¨æ ¼ä¸Šæ–¹ç­›é€‰bar ç­›é€‰è¿‡åçš„issuesï¼ˆjsonï¼‰
                console.log("Number of Filtered issues: ", filteredData.length); // Debugging
                //---------------------------------------------------------------------------------
                //---------------------æ¥ä¸‹æ¥æ ¹æ®éœ€è¦ï¼Œè°ƒæ•´filteredDataï¼Œæ”¾åœ¨å››ä¸ªè¡¨æ ¼ä¸­-------------------
                //---------------------------------------------------------------------------------
                //---------------------------------------------------------------------------------




                // å¾—åˆ° userArrayï¼Œæ¯ä¸ªelement objectæ‹¥æœ‰ä¸¤ä¸ªå‚æ•°ï¼šname(String)å’Œissues(Object)
                const userGroups = filteredData.reduce((groups, issue) => {
                    const checkUserName = issue.assignee?.remark; // Use optional chaining to handle null or undefined values
                    let userName = "æ— åæ°";
                    if (checkUserName === null) {
                        userName = issue.assignee?.name;
                    } else {
                        userName = checkUserName;
                    }
                    if (userName) { // Check if userName is truthy (not null or undefined)
                        if (!groups[userName]) {
                            groups[userName] = [];
                        }
                        groups[userName].push(issue);
                    }
                    return groups;
                }, {});

                const userArray = Object.keys(userGroups).map((userName) => ({
                    name: userName,
                    issues: userGroups[userName],
                }));
                console.log("Number of users: ", userArray.length); // Debugging



                // fill the First table
                const tbody1 = document.querySelector('#tbody_progress');
                tbody1.innerHTML = ''; 
                const userRows1 = [];
                let issueCount = 0;
                let everyone_past_due_and_unfinished_count = -1;
                userArray.forEach((user) => {
                    const user_past_due_and_unfinished_count = user.issues.filter(issue => {
                        if (!issue.deadline) { return false;} // Skip issues without a deadline
                        const today = new Date();
                        const deadline = new Date(issue.deadline);
                        const past_due = today >= deadline;
                        const unfinished = ['å¾…åŠçš„', 'å·²ç¡®è®¤', 'è¿›è¡Œä¸­'].includes(issue.issue_state);
                        return past_due && unfinished;
                    }).length;

                    everyone_past_due_and_unfinished_count = filteredData.filter(issue => {
                        if (!issue.deadline) { return false;} // Skip issues without a deadline
                        const today = new Date();
                        return (today >= new Date(issue.deadline)) && (['å¾…åŠçš„', 'å·²ç¡®è®¤', 'è¿›è¡Œä¸­'].includes(issue.issue_state));
                    }).length;

                    const percentage_past_due_and_unfinished = (user_past_due_and_unfinished_count / everyone_past_due_and_unfinished_count * 100).toFixed(1);
                    
                    const userRow = {
                        name: user.name,
                        pastDueAndUnfinishedCount: user_past_due_and_unfinished_count,
                        percentagePastDueAndUnfinished: parseFloat(percentage_past_due_and_unfinished)
                    };
                    userRows1.push(userRow);
                });
                // åˆ—è¡¨æ’åº
                //userRows1.sort((a, b) => a.percentagePastDueAndUnfinished - b.percentagePastDueAndUnfinished); // ç”±å°åˆ°å¤§æ’åº
                userRows1.sort((a, b) => b.percentagePastDueAndUnfinished - a.percentagePastDueAndUnfinished); // ç”±å¤§åˆ°å°æ’åº
                let rowNumber1 = 0; 
                userRows1.forEach((userRow) => {
                    // if (userRow.pastDueAndUnfinishedCount === 0) {
                    //     return;
                    // }
                    const row = document.createElement('tr');
                    rowNumber1++;
                    row.innerHTML = `
                    <td>${rowNumber1}</td>
                    <td>${userRow.name}</td>
                    <td>${userRow.pastDueAndUnfinishedCount}</td>
                    <td>${userRow.percentagePastDueAndUnfinished}%</td>
                    <td><input type="text" class="form-control" /></td>
                    `;
                    tbody1.appendChild(row);
                });
                //å æ¯” å½“å‰é€¾æœŸ+ä»»åŠ¡æœªå®Œæˆæ€»æ•°é‡
                const th1 = document.querySelector('#th_progress');
                th1.innerHTML = `å æ¯” å½“å‰é€¾æœŸ+æœªå®Œæˆæ€»æ•°é‡(${everyone_past_due_and_unfinished_count})`; 
                


                // fill the Second table
                const tbody2 = document.querySelector('#tbody_attitude');
                tbody2.innerHTML = ''; 
                let rowNumber2 = 0; 
                userArray.forEach((user) => {
                    const uncommented_issues = user.issues.filter(issue => {
                        if (!issue.deadline) { return false;} // Skip issues without a deadline
                        const today = new Date();
                        return (today >= new Date(issue.deadline)) && (['å¾…åŠçš„', 'å·²ç¡®è®¤', 'è¿›è¡Œä¸­'].includes(issue.issue_state)) && (issue.comments === 0);
                    });
                    if (uncommented_issues.length === 0) { // Hide empty rows
                        return;
                    }
                    const title_array = uncommented_issues.map(issue => issue.title);
                    const url_array = uncommented_issues.map(issue => issue.html_url);
                    const anchorTags = title_array.map((title, index) => `<li><a href="${url_array[index]}"  class="btn btn-light">${title}</a></li>`);
                    const anchorTagsHTML = `<ul>${anchorTags.join('')}</ul>`;

                    const row = document.createElement('tr');
                    rowNumber2++;
                    row.innerHTML = `
                    <td>${rowNumber2}</td>
                    <td>${user.name}</td>
                    <td>${uncommented_issues.length}</td>
                    <td>${anchorTagsHTML}</td>
                    <td><input type="text" class="form-control" /></td>
                    `;
                    tbody2.appendChild(row);
                });



                // fill the Third table
                const tbody3 = document.querySelector('#tbody_intensity');
                tbody3.innerHTML = ''; 
                const userRows3 = [];
                let rowNumber3 = 0;
                userArray.forEach((user) => {
                    const percentage = (user.issues.length / filteredData.length * 100).toFixed(1) + '%';
                    const userRow = {
                        name: user.name,
                        userIssuesLength: user.issues.length,
                        percentage_: parseFloat(percentage)
                    }
                    userRows3.push(userRow);
                });
                // åˆ—è¡¨æ’åº
                //userRows3.sort((a, b) => a.percentage_ - b.percentage_); // ç”±å°åˆ°å¤§æ’åº
                userRows3.sort((a, b) => b.percentage_ - a.percentage_); // ç”±å¤§åˆ°å°æ’åº
                userRows3.forEach((userRow) => {
                    rowNumber3++;
                    const row = document.createElement('tr');
                    row.innerHTML = `
                    <td>${rowNumber3}</td>
                    <td>${userRow.name}</td>
                    <td>${userRow.userIssuesLength}</td>
                    <td>${userRow.percentage_}%</td>
                    <td><input type="text" class="form-control" /></td>
                    `;
                    tbody3.appendChild(row);
                });
                const th3 = document.querySelector('#th_intensity');
                th3.innerHTML = `å æ¯” æ‰€æœ‰äººå·¥ä½œé¡¹æ€»æ•°é‡(${filteredData.length})`; 



                // fill the Fourth table
                const tbody4 = document.querySelector('#tbody_individual');
                tbody4.innerHTML = ''; 
                const userRows4 = [];
                let rowNumber4 = 0;
                userArray.forEach((user) => {
                    const unfinished_count = user.issues.filter(issue => ['å¾…åŠçš„', 'å·²ç¡®è®¤', 'è¿›è¡Œä¸­'].includes(issue.issue_state)).length;
                    const rejected_count = user.issues.filter(issue => ['æš‚ä¸å¤„ç†'].includes(issue.issue_state)).length;
                    const unfinished_percentage = (unfinished_count / user.issues.length * 100).toFixed(1);
                    const userRow = {
                        name: user.name,
                        unfinished_percentage: parseFloat(unfinished_percentage),
                        unfinished_count: parseFloat(unfinished_count),
                        rejected_count: parseFloat(rejected_count)
                    }
                    userRows4.push(userRow);
                });
                // åˆ—è¡¨æ’åº
                //userRows4.sort((a, b) => a.unfinished_count - b.unfinished_count); // ç”±å°åˆ°å¤§æ’åº
                userRows4.sort((a, b) => b.unfinished_count - a.unfinished_count); // ç”±å¤§åˆ°å°æ’åº
                userRows4.forEach((userRow) => {
                    rowNumber4++;
                    const row = document.createElement('tr');
                    row.innerHTML = `
                    <td>${rowNumber4}</td>
                    <td>${userRow.name}</td>
                    <td>${userRow.unfinished_count}</td>
                    <td>${userRow.unfinished_percentage}%</td>
                    <td>${userRow.rejected_count}</td>
                    <td><input type="text" class="form-control" /></td>
                    `;
                    tbody4.appendChild(row);
                });

                // const row = document.createElement('tr');
                //     row.innerHTML = `
                //     <td>${user.name}</td>
                //     <td>${unfinished_percentage}%</td>
                //     <td>${finished_percentage}%</td>
                //     <td><input type="text" class="form-control" /></td>
                //     `;
                //     tbody4.appendChild(row);

                console.log("Done populating all four tables!");

                //~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~é¥¼å›¾~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
                

                // First pie chart update
                if (pieChartInstance1 !== undefined) {
                    const userNames1 = userRows1.map(userRow => userRow.name);
                    const percentages1 = userRows1.map(userRow => userRow.percentagePastDueAndUnfinished);
                    pieChartInstance1.data.labels = userNames1;
                    pieChartInstance1.data.datasets[0].data = percentages1;
                    pieChartInstance1.update();
                }

                // Third pie chart
                if (pieChartInstance3 !== undefined) {
                    const userNames3 = userRows3.map(userRow => userRow.name);
                    const percentages3 = userRows3.map(userRow => userRow.percentage_);
                    pieChartInstance3.data.labels = userNames3;
                    pieChartInstance3.data.datasets[0].data = percentages3;
                    pieChartInstance3.update();
                }

            });
        });
    </script>
    
</body>
</html>

    <!-- The data passed into 'table.ejs' from 'app.js':
      {
        assigneeName: 'Assignee Name',
        stateCounts: {
          'open': 5,
          'closed': 3,
          // ... other state counts
        },
        filteredIssuesCount: 8,
        issueTitles_priority: ['Title 1', 'Title 2', 'Title 3'],
        issueTitles_all: ['Title 4', 'Title 5', 'Title 6'],
        issueTitles_progress: ['Open', 'Closed', 'In Progress']
        // ... other data specific to the assignee
      } -->
